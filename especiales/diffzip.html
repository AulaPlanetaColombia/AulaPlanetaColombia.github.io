<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="icon" type="image/png" href="../favicon.png"><!-- Major Browsers -->
        <!--[if IE]><link rel="SHORTCUT ICON" href="../favicon.ico"/><![endif]--><!-- Internet Explorer-->
        <title>aulaPlaneta Colombia</title>

        <!-- Bootstrap -->
        <link href="../css/bootstrap.min.css" rel="stylesheet">
        <link href="../css/font-awesome.min.css" rel="stylesheet">
        <link href="../css/dropzone.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
        <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
        <![endif]-->
    </head>
    <body>
        <nav class="navbar navbar-default">
            <div class="container-fluid">
                <a class="navbar-brand volver" href="#">
                    <i class="fa fa-chevron-left"></i>&nbsp;&nbsp; Volver
                </a>
            </div>
        </nav>
        <div class="container">
            <div class="row">
                <div class="col-sm-6">
                    <form action="/file-upload" class="dropzone" id="origen-dropzone"></form>
                </div>
                <div class="col-sm-6">
                    <form action="/file-upload" class="dropzone" id="final-dropzone"></form>
                </div>
            </div><!-- /.row -->
            <div class="row">
                <div class="col-sm-12">
                    <br><br>
                    <button type="button" class="iniciaDiff btn btn-lg btn-primary btn-block" disabled="disabled">Iniciar comparaci√≥n</button>
                </div>
            </div><!-- /.row -->
            <div class="row">
                <div class="col-sm-12 prueba">
                </div>
                <div class="col-sm-12 resultado">
                </div>
            </div><!-- /.row -->
        </div>

        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <!-- Include all compiled plugins (below), or include individual files as needed -->
        <script src="../js/bootstrap.min.js"></script>
        <script src="../js/dropzone.js"></script>
        <script src="../js/aulaPlaneta.js"></script>
        <script src="../js/zip.js"></script>
        <script src="../js/zip-fs.js"></script>
        <script src="../js/diff.js"></script>
        <script type="text/javascript">
            zip.workerScriptsPath = "/js/";
            var zipCargado = 0, zipOriginal, zipFinal, fsOriginal = new zip.fs.FS(), fsFinal = new zip.fs.FS(), idFinal;
            var originales = [];
            var finales = [];
            volverAnterior('.volver');
            Dropzone.options.origenDropzone = {
                paramName: "origen",
                maxFilesize: 2048,
                clickable: true,
                dictDefaultMessage: "<i class='fa fa-arrow-circle-o-down fa-5x'></i><br>Arrastre y suelte el ZIP <strong>original</strong> sobre esta zona, o haga clic para seleccionar un archivo.",
                acceptedFiles: ".zip",
                uploadMultiple: false,
                autoProcessQueue: false,
                init: function() {
                    this.on("addedfile", function(file) {
                        zipCargado++;
                        zipOriginal = file;
                        activaTrigger();
                    });
                }
            };
            Dropzone.options.finalDropzone = {
                paramName: "final",
                maxFilesize: 2048,
                clickable: true,
                dictDefaultMessage: "<i class='fa fa-arrow-circle-o-down fa-5x'></i><br>Arrastre y suelte el ZIP <strong>corregido</strong> sobre esta zona, o haga clic para seleccionar un archivo.",
                acceptedFiles: ".zip",
                uploadMultiple: false,
                autoProcessQueue: false,
                init: function() {
                    this.on("addedfile", function(file) {
                        zipCargado++;
                        zipFinal = file;
                        activaTrigger();
                    });
                }
            };
            function activaTrigger() {
                if (zipCargado > 1) {
                    $('.iniciaDiff').removeAttr('disabled').click(function(){
                        startDiff();
                    });
                }
            }
            function startDiff() {
                cargaBlob(fsOriginal, zipOriginal, 0);
                cargaBlob(fsFinal, zipFinal, 1);
            }
            function cargaBlob(fsObject, blob, num) {
                fsObject.importBlob(blob, function(){
                    for (var i = 1; i < fsObject.entries.length; i++) {
                        var ext = fsObject.getById(i).name.split('.').pop().toLowerCase();
                        if (fsObject.getById(i).name !== undefined && (ext == 'html' || ext == 'htm')) {
                            idFinal = fsObject.getById(i).id;
                        }
                    }
                    buscaDentro(fsObject.root, num);
                }, function(error){
                    console.log('Error: ' + error);
                });
            }
            function buscaDentro(nodo, num) {
                if (nodo.directory) {
                    nodo.children.forEach(function(elemento, index) {
                        if (!elemento.directory) {
                            var nombreElemento = elemento.getFullname().split('/').pop();
                            var extensionElemento = nombreElemento.split('.').pop().toLowerCase();
                            if (extensionElemento == 'html' || extensionElemento == 'htm') {
                                if (elemento.parent.name != undefined && elemento.parent.name != "InfoGuion") {
                                    var dir = fsOriginal.find(elemento.parent.name);
                                    var info = dir.getChildByName('infoRecurso.xml');
                                    info.getText(function(texto){
                                        var contenido = $.parseXML(texto);
                                        var titulo = $(contenido).find('titulo');
                                        var LoID = $(contenido).find('loid');
                                        cargaDatos(nombreElemento, titulo.text(), LoID.text(), elemento, num);
                                    });
                                } else {
                                    cargaDatos(nombreElemento, "", "", elemento, num);
                                }
                            }
                        }
                        buscaDentro(elemento, num);
                    });
                }
            }
            function cargaDatos(nombre, titulo, LoID, elemento, num){
                elemento.getText(function(texto){
                    var contenido = [];
                    $.parseHTML($.trim(texto)).forEach(function(ele, ind) {
                        if ($.trim($(ele).html()) !== undefined && $.trim($(ele).html()) != '') {
                            contenido.push($.trim($(ele).html()));
                        }
                    });
                    var objeto = {nombre: nombre, titulo: titulo, loid: LoID, contenido: contenido};
                    if (num == 0) {
                        originales.push(objeto);
                    } else {
                        finales.push(objeto);
                        if (elemento.id == idFinal) {
                            comparaTextos();
                        }
                    }
                });
            };
            function comparaTextos() {
                originales.forEach(function(elemento, index){
                    $('.resultado')
                    $('.resultado').append('<h2>'+originales[index].nombre+'</h2>');
                    var resultado;
                    originales[index].contenido.forEach(function(ele, ind) {
                        var diff = JsDiff.diffWords(originales[index].contenido[ind], finales[index].contenido[ind]);
                        //var diff = JsDiff.diffWords(originales[index].contenido, finales[index].contenido);
                        diff.forEach(function(part){
                            var span = document.createElement('span');
                            if (part.added) {
                                $(span).css({'color': 'green', 'text-decoration': 'underline'});
                            } else if (part.removed) {
                                $(span).css({'color': 'red', 'text-decoration': 'line-through'});
                            } else {
                                $(span).css('color', 'black');
                            }
                            resultado += span;
                            $(span).html(part.value);
                            $('.resultado').append(span);
                        });
                    });
                });
            };
        </script>
    </body>
</html>
